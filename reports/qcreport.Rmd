---
title: "CPTAC Study Consistency Report"
author: "Simina Boca, Shaojun Tang, Yi Bai, Jiahao Huang, Nathan Edwards"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
params:
  qcmetricsfile: inputfilename.tsv
  summaryfile: inputfilename.tsv
  peptidefile: inputfilename.tsv
  quantfile: inputfilename.tsv
  mayufile: inputfilename.tsv
  expdesfile: inputfilename.tsv
  format: html_document
  debug: true
  dochecks: false
output:
  html_document:
    number_sections: yes
    smooth_scroll: no
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    number_sections: yes
    toc: yes
always_allow_html: yes
---

<!--Resize the main-container to spread the title-->
<style>
body .main-container {
max-width: 2030px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r, warning=TRUE, include=FALSE}
library(ggplot2)
library(reshape2)
library(knitr)
library(kableExtra)
library(RColorBrewer) ## generate palette
library(grid)
library(pander) ## this package is used ot convert the .md file into PDF
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(gridExtra)) ## to show the plots side by side 
suppressPackageStartupMessages(library(plotly))
options(warn = -1,scipen=1000000)
```

```{r}
# this allows the kable function work in html format to make pretty tables
#but will not work in the PDF files, remember to remove it if generating PDF files
#also remving the lines with kable in the code chunks related
if (params$format != 'pdf_document') {
  options(knitr.table.format = "html")  
}
```

```{r,include=FALSE}
##Read in metrics for individual analytical samples and fractions and check number of fractions and samples

mylog <- function(s) {
  if (params$debug) {
    capture.output(cat(c("MYLOG:",deparse(substitute(s)),"\n")),file='debug.log',append=TRUE)
    capture.output(s,file='debug.log',append=TRUE)
    capture.output(cat("\n"),file='debug.log',append=TRUE)
  }
}
file.remove('debug.log')

QCmetrics_file <- params$qcmetricsfile
Summary_file <- params$summaryfile
Peptide_file <- params$peptidefile
tmt10_file <- params$quantfile
mayu_file <- params$mayufile
expdes_file <- params$expdesfile
outexpdes_file <- sub('\\.qcmetrics\\.','\\.expdesign\\.',QCmetrics_file)

QCmetrics <- read.table(QCmetrics_file, header=TRUE, sep="\t", quote = "")
SUmetrics <- read.table(Summary_file,   header=TRUE, sep="\t", quote = "")
PEmetrics <- read.table(Peptide_file,   header=TRUE, sep="\t", quote = "")
MYmetrics <- read.table(mayu_file,   sep="\t", quote = "")

# Read experimental design, select key columns, and remove duplicate rows.
# rename columns to match QCmetrics to ease merge
expdes <- read.table(expdes_file, header=TRUE, sep=",", quote = "", fill=TRUE, colClasses="character")
expdes1 <- expdes;

expdes <- subset(expdes, select=c(spectrafile,analyticalsample,analyticalsampleordinal,fraction))
expdes <- expdes[!duplicated(expdes$spectrafile),]

if (!setequal(expdes$spectrafile,QCmetrics$spectrumBasename)) { 
  mylog(expdes)
  mylog(QCmetrics)
  stopifnot(setequal(expdes$spectrafile,QCmetrics$spectrumBasename))
}                                                                                                                       

tmp <- strsplit(expdes1$denominator,split=";")
times=sapply(tmp, length)
tmp[times==0] = c("")
expdes1 <- expdes1[rep(row.names(expdes1), times=sapply(tmp, length)),]
expdes1$denominator <- unlist(tmp)
expdes1$ratioordinal <- as.numeric(sub(':.*$','',expdes1$denominator))
expdes1$denominator <- sub('^\\d+:','',expdes1$denominator)
expdes1$labelratios <- sprintf("%s/%s",expdes1$label,expdes1$denominator)
expdes1 <- merge(expdes1,subset(expdes1, select=c('spectrafile','label','sample')), 
                 by.x=c('spectrafile','denominator'),by.y=c('spectrafile','label'),
                 suffixes = c("","_denominator"))
expdes1$sampleratios <- sprintf("%s/%s",expdes1$sample,expdes1$sample_denominator)
expdes1 <- expdes1[expdes1$denominator!="",]
expdes1 <- expdes1[!duplicated(subset(expdes1, select=c(sample,analyticalsampleordinal,label,denominator,labelratios,ratioordinal,sampleratios))),]

expdes1$labelfactor <- factor(expdes1$label,levels=unique(expdes1$label))
expdes1$labelratiosfactor <- factor(expdes1$labelratios,levels=unique(expdes1$labelratios))
expdes1$analyticalsampleordinal = as.numeric(expdes1$analyticalsampleordinal);
expdes1$analyticalsampleordinalstr = sprintf("%02d",expdes1$analyticalsampleordinal);
# expdes1$analyticalsampleordinalstr = sprintf("%d",expdes1$analyticalsampleordinal);
expdes1$analyticalsampleascolumn <- make.names(expdes1$analyticalsample)
expdes1$sampleascolumn <- make.names(expdes1$sample)
expdes1$sampleratiosascolumn <- make.names(expdes1$sampleratios)
expdes1 <- expdes1[with(expdes1, order(analyticalsampleordinal,ratioordinal)),]

number_of_numerator_labels = length(unique(expdes1$labelratios))
min_samples_per_analyticalsample = min(table(expdes1$analyticalsampleordinal))
samples_per_analyticalsample = max(table(expdes1$analyticalsampleordinal))
 
# Overwrite the QCmetrics values based on the expdes file...
QCmetrics <- merge(QCmetrics,expdes,by.x='spectrumBasename',by.y='spectrafile')
QCmetrics$analyticalBasename <- QCmetrics$analyticalsample
QCmetrics$analyticalsample <- NULL
QCmetrics$fractionNum <- QCmetrics$fraction
QCmetrics$fraction <- NULL

##rename "fractionNum" to "Fraction"
QCmetrics$Fraction <- QCmetrics$fractionNum
QCmetrics$fractionNum <- NULL

QCmetrics$analyticalBasenameLabel <- QCmetrics$analyticalBasename
orderedabs = unique(QCmetrics[order(as.numeric(QCmetrics$analyticalsampleordinal)),]$analyticalBasenameLabel)
QCmetrics$analyticalBasenameFactor <- factor(QCmetrics$analyticalBasenameLabel,levels=orderedabs,ordered=TRUE)
QCmetrics$analyticalBasenameIndex <- as.numeric(QCmetrics$analyticalsampleordinal)
QCmetrics$analyticalBasenameIndexStr <- sprintf("%02d",as.numeric(QCmetrics$analyticalsampleordinal))

# if these are left as numbers, the color scale is messed up. Why?
# This will ensure proper sort order (at least until 100 analytical samples)
QCmetrics$analyticalBasename <- sprintf("%02d",QCmetrics$analyticalBasenameIndex)

##add some new columns to QCmetrics (same as other columns, but useful for tooltip!)
QCmetrics$`Analytical sample` <- QCmetrics$analyticalBasenameIndex

# summary(QCmetrics$analyticalBasename)
# summary(QCmetrics$analyticalBasenameIndex)

##get total number of spectra per analytical sample
numofMS2_ALL_per_AS <- tapply(QCmetrics$numofMS2_ALL, INDEX=QCmetrics$analyticalBasename, FUN=sum)
numofMS2_ID_per_AS <- tapply(QCmetrics$numofMS2_ID, INDEX=QCmetrics$analyticalBasename, FUN=sum)
identical(names(numofMS2_ALL_per_AS), names(numofMS2_ID_per_AS))

QCmetrics_AS <- data.frame(analyticalBasename=names(numofMS2_ID_per_AS),
                           numofMS2_ALL_per_AS=numofMS2_ALL_per_AS,
                           numofMS2_ID_per_AS=numofMS2_ID_per_AS)
QCmetrics_AS$`Analytical sample` <- QCmetrics_AS$analyticalBasenameIndex
```

```{r,include=FALSE}
## Get the fractions, give a number to the non-number fractions
## There must be a more straightfoward way to do this!!!!

QCmetrics$FractionString <- as.character(QCmetrics$Fraction)
fracnums <- as.numeric(QCmetrics$FractionString)
fracisnum <- !is.na(fracnums)
fraclabs <- data.frame(ufraclab=unique(QCmetrics$Fraction[order(fracnums,QCmetrics$FractionString)]))
fraclabs$ufraclab<-as.character(fraclabs$ufraclab)
ufracnums <- as.numeric(fraclabs$ufraclab)
ufracisnum <- !is.na(ufracnums)
fraclabs$fracindex <- 1:length(fraclabs$ufraclab)
if (sum(ufracisnum) == 0) {
    maxfracnum <- 0
} else {
    maxfracnum <- max(ufracnums[ufracisnum])
}
fraclabs$fracnum <- ufracnums
fraclabs$fracnum[!ufracisnum] <- (maxfracnum+1):(maxfracnum+(sum(!ufracisnum)))
QCmetrics <- merge(QCmetrics,fraclabs,by.x='Fraction',by.y='ufraclab')
QCmetrics$FractionIndex <- QCmetrics$fracindex
QCmetrics$fracindex <- NULL
QCmetrics$FractionNumber <- QCmetrics$fracnum
QCmetrics$fracnum <- NULL

## Now QCmetrics has Fraction (factor, probably), FractionString, FractionIndex, and FractionNumber
## Single alpha letter fractions come after all numbers.

QCmetrics$Fraction <- QCmetrics$FractionString

```

```{r, include=FALSE}
##Get the number of unique analytical samples

analyticalSamples <- unique(QCmetrics$analyticalBasename)
length(analyticalSamples)

##Make sure the labels in spectrumBasename are unique

length(unique(QCmetrics$spectrumBasename))

##Get the number of unique fractions
fractions <- unique(QCmetrics$Fraction)
```

```{r,include=FALSE}
##Change some column names to make things easier
QCmetrics <- rename(QCmetrics,
                    PrecursorIntensityALL.0 = minPrecursorIntensity_ALL,
                    PrecursorIntensityALL.5 = PrecursorIntensity5perc_ALL,
                    PrecursorIntensityALL.25 = PrecursorIntensity25perc_ALL,
                    PrecursorIntensityALL.50 = PrecursorIntensity50perc_ALL,
                    PrecursorIntensityALL.75 = PrecursorIntensity75perc_ALL,
                    PrecursorIntensityALL.95 = PrecursorIntensity95perc_ALL,
                    PrecursorIntensityALL.100 = maxPrecursorIntensity_ALL)
QCmetrics <- rename(QCmetrics,
                    PrecursorMZALL.0 = minPrecursorMZ_ALL,
                    PrecursorMZALL.5 = PrecursorMZ5perc_ALL,
                    PrecursorMZALL.25 = PrecursorMZ25perc_ALL,
                    PrecursorMZALL.50 = PrecursorMZ50perc_ALL,
                    PrecursorMZALL.75 = PrecursorMZ75perc_ALL,
                    PrecursorMZALL.95 = PrecursorMZ95perc_ALL,
                    PrecursorMZALL.100 = maxPrecursorMZ_ALL)

QCmetrics <- rename(QCmetrics,
                    PrecursorMWALL.0 = minPrecursorMW_ALL,
                    PrecursorMWALL.5 = PrecursorMW5perc_ALL,
                    PrecursorMWALL.25 = PrecursorMW25perc_ALL,
                    PrecursorMWALL.50 = PrecursorMW50perc_ALL,
                    PrecursorMWALL.75 = PrecursorMW75perc_ALL,
                    PrecursorMWALL.95 = PrecursorMW95perc_ALL,
                    PrecursorMWALL.100 = maxPrecursorMW_ALL)

QCmetrics <- rename(QCmetrics,
                    MS2perMS1ALL.0 = minMS2perMS1_ALL,
                    MS2perMS1ALL.5 = MS2perMS1_5perc_ALL,
                    MS2perMS1ALL.25 = MS2perMS1_25perc_ALL,
                    MS2perMS1ALL.50 = MS2perMS1_50perc_ALL,
                    MS2perMS1ALL.75 = MS2perMS1_75perc_ALL,
                    MS2perMS1ALL.95 = MS2perMS1_95perc_ALL,
                    MS2perMS1ALL.100 = maxMS2perMS1_ALL)
QCmetrics <- rename(QCmetrics,
                    MS2chargeALL.1 = MS2Charge1_ALL,
                    MS2chargeALL.2 = MS2Charge2_ALL,
                    MS2chargeALL.3 = MS2Charge3_ALL,
                    MS2chargeALL.4 = MS2Charge4_ALL,
                    MS2chargeALL.5andhigher = MS2Charge5_ALL##MS2Charge5andHigher_ALL,
                   )
## Adding Redundancy (Jiahao)
QCmetrics <- rename(QCmetrics,
                    PeptideRd.0 = minPeptideRedundancy,
                    PeptideRd.5 = PeptideRedundancy5perc,
                    PeptideRd.25 = PeptideRedundancy25perc,
                    PeptideRd.50 = PeptideRedundancy50perc,
                    PeptideRd.75 = PeptideRedundancy75perc,
                    PeptideRd.95 = PeptideRedundancy95perc,
                    PeptideRd.100 = maxPeptideRedundancy)

# Adding Retention Time ALL
QCmetrics <- rename(QCmetrics,
                    RetentionTimeALL.0 = minRetentionTime_ALL,
                    RetentionTimeALL.5 = RetentionTime5perc_ALL,
                    RetentionTimeALL.25 = RetentionTime25perc_ALL,
                    RetentionTimeALL.50 = RetentionTime50perc_ALL,
                    RetentionTimeALL.75 = RetentionTime75perc_ALL,
                    RetentionTimeALL.95 = RetentionTime95perc_ALL,
                    RetentionTimeALL.100 = maxRetentionTime_ALL)

charge0avail <- FALSE
if ("MS2Charge0_ALL" %in% colnames(QCmetrics)) {
    QCmetrics <- rename(QCmetrics,
                        MS2chargeALL.0 = MS2Charge0_ALL)
    charge0avail <- TRUE
}
##Create data frame melting the precursor intensities
QCmetricsLongPrecInt_ALL <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|PrecursorIntensityALL\\.\\d+)$",
                                                 colnames(QCmetrics))],
                             variable.name="PrecursorIntensityALL",
                             value.name="value",
                             id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecInt_ALL)
QCmetricsLongPrecInt_ALL <- cbind(QCmetricsLongPrecInt_ALL[,1:2],
                              colsplit(QCmetricsLongPrecInt_ALL[,3], "\\.",
                                       c("PrecursorIntensityALL","Percentile")),
                              QCmetricsLongPrecInt_ALL[,4])
head(QCmetricsLongPrecInt_ALL)
colnames(QCmetricsLongPrecInt_ALL)[5] <- "value"

QCmetricsLongPrecInt_ALL$`Analytical sample` <- QCmetricsLongPrecInt_ALL$analyticalBasename
QCmetricsLongPrecInt_ALL$Fraction <- QCmetricsLongPrecInt_ALL$Fraction

##Create data frame melting the precursor MZ values
QCmetricsLongPrecMZ_ALL <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|PrecursorMZALL\\.\\d+)$",
                                                colnames(QCmetrics))],
                            variable.name="PrecursorMZALL",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecMZ_ALL)
QCmetricsLongPrecMZ_ALL <- cbind(QCmetricsLongPrecMZ_ALL[,1:2],
                             colsplit(QCmetricsLongPrecMZ_ALL[,3], "\\.",
                                      c("PrecursorMZALL","Percentile")),
                             QCmetricsLongPrecMZ_ALL[,4])
head(QCmetricsLongPrecMZ_ALL)
colnames(QCmetricsLongPrecMZ_ALL)[5] <- "value"

QCmetricsLongPrecMZ_ALL$`Analytical sample` <- QCmetricsLongPrecMZ_ALL$analyticalBasename
QCmetricsLongPrecMZ_ALL$Fraction <- QCmetricsLongPrecMZ_ALL$Fraction

##Create data frame melting the precursor MW values
QCmetricsLongPrecMW_ALL <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|PrecursorMWALL\\.\\d+)$",
                                                colnames(QCmetrics))],
                            variable.name="PrecursorMWALL",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecMW_ALL)
QCmetricsLongPrecMW_ALL <- cbind(QCmetricsLongPrecMW_ALL[,1:2],
                             colsplit(QCmetricsLongPrecMW_ALL[,3], "\\.",
                                      c("PrecursorMWALL","Percentile")),
                             QCmetricsLongPrecMW_ALL[,4])
head(QCmetricsLongPrecMW_ALL)
colnames(QCmetricsLongPrecMW_ALL)[5] <- "value"

QCmetricsLongPrecMW_ALL$`Analytical sample` <- QCmetricsLongPrecMW_ALL$analyticalBasename
QCmetricsLongPrecMW_ALL$Fraction <- QCmetricsLongPrecMW_ALL$Fraction

##Create data frame melting the MS2perMS values
QCmetricsLongMS2perMS_ALL <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|MS2perMS1ALL\\.\\d+)$",
                                                  colnames(QCmetrics))],
                              variable.name=" MS2perMS1ALL",
                            value.name="value",
                              id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongMS2perMS_ALL)
QCmetricsLongMS2perMS_ALL <- cbind(QCmetricsLongMS2perMS_ALL[,1:2],
                               colsplit(QCmetricsLongMS2perMS_ALL[,3], "\\.",
                                        c("MS2perMS1ALL","Percentile")),
                               QCmetricsLongMS2perMS_ALL[,4])
head(QCmetricsLongMS2perMS_ALL)
colnames(QCmetricsLongMS2perMS_ALL)[5] <- "value"

QCmetricsLongMS2perMS_ALL$`Analytical sample` <- QCmetricsLongMS2perMS_ALL$analyticalBasename
QCmetricsLongMS2perMS_ALL$Fraction <- QCmetricsLongMS2perMS_ALL$Fraction

##Create data frame melting MS2 charge ratio
QCmetricsLongMS2Charge_ALL <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|MS2chargeALL\\.\\d+[a-z]*)$",
                                                   colnames(QCmetrics))],
                                    variable.name="MS2chargeALL",
                                    value.name="value",
                                    id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongMS2Charge_ALL)
QCmetricsLongMS2Charge_ALL <- cbind(QCmetricsLongMS2Charge_ALL[,1:2],
                                     colsplit(QCmetricsLongMS2Charge_ALL[,3], "\\.", c("MS2chargeALL","MS2ChargeState")),
                                     QCmetricsLongMS2Charge_ALL[,4])
head(QCmetricsLongMS2Charge_ALL)
colnames(QCmetricsLongMS2Charge_ALL)[5] <- "value"
QCmetricsLongMS2Charge_ALL$MS2chargeALL <- NULL
totalMS2_ALL = sum(QCmetricsLongMS2Charge_ALL$value)
QCmetricsLongMS2Charge_ALL$Chargeratio<- c(QCmetricsLongMS2Charge_ALL$value/totalMS2_ALL)

QCmetricsLongMS2Charge_ALL$`Analytical sample` <- QCmetricsLongMS2Charge_ALL$analyticalBasename
QCmetricsLongMS2Charge_ALL$Fraction <- QCmetricsLongMS2Charge_ALL$Fraction

# Create data frame melting Peptie Redundancy (Jiahao)
QCmetricsPeptideRd <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|PeptideRd\\.\\d+)$",
                                           colnames(QCmetrics))],
                            variable.name="PeptideRd",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsPeptideRd)
QCmetricsPeptideRd <- cbind(QCmetricsPeptideRd[,1:2],
                             colsplit(QCmetricsPeptideRd[,3], "\\.",
                                      c("PeptideRd","Percentile")),
                             QCmetricsPeptideRd[,4])
head(QCmetricsPeptideRd)
colnames(QCmetricsPeptideRd)[5] <- "value"

QCmetricsPeptideRd$`Analytical sample` <- QCmetricsPeptideRd$analyticalBasename
QCmetricsPeptideRd$Fraction <- QCmetricsPeptideRd$Fraction

# Create data frame melting Retention Time All
QCmetricsPeptideRT_ALL <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|RetentionTimeALL\\.\\d+)$",
                                               colnames(QCmetrics))],
                            variable.name="RetentionTimeALL",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsPeptideRT_ALL)
QCmetricsPeptideRT_ALL <- cbind(QCmetricsPeptideRT_ALL[,1:2],
                             colsplit(QCmetricsPeptideRT_ALL[,3], "\\.",
                                      c("RetentionTimeALL","Percentile")),
                             QCmetricsPeptideRT_ALL[,4])
head(QCmetricsPeptideRT_ALL)
colnames(QCmetricsPeptideRT_ALL)[5] <- "value"

QCmetricsPeptideRT_ALL$`Analytical sample` <- QCmetricsPeptideRT_ALL$analyticalBasename
QCmetricsPeptideRT_ALL$Fraction <- QCmetricsPeptideRT_ALL$Fraction

# Create dataframe for different charge state
# create the label

if (charge0avail) {
  chargestate <- c("N/A","+1","+2", "+3","+4",">= +5")
} else {
  chargestate <- c("+1","+2", "+3","+4",">= +5")
}

#calculate the ratio for each of the charge state   
chargestateratio_ALL <- 
  c(sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == 1,select=c(Chargeratio))), 
    sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == 2,select=c(Chargeratio))), 
    sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == 3,select=c(Chargeratio))), 
    sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == 4,select=c(Chargeratio))), 
    sum(subset(QCmetricsLongMS2Charge_ALL, 
               MS2ChargeState == "5andhigher",select=c(Chargeratio))))

if (charge0avail) {
  chargestateratio_ALL <- c(sum(subset(QCmetricsLongMS2Charge_ALL,                                                                       MS2ChargeState == 0,select=c(Chargeratio))),chargestateratio_ALL)
}

#generate the data frame contains the cahrge ratio
Chargeratio_ALL <- data.frame(chargestate, chargestateratio_ALL)
```

```{r,include=FALSE}
##Change some column names to make things easier
QCmetrics <- rename(QCmetrics,
                    PrecursorIntensityID.0 = minPrecursorIntensity_ID,
                    PrecursorIntensityID.5 = PrecursorIntensity5perc_ID,
                    PrecursorIntensityID.25 = PrecursorIntensity25perc_ID,
                    PrecursorIntensityID.50 = PrecursorIntensity50perc_ID,
                    PrecursorIntensityID.75 = PrecursorIntensity75perc_ID,
                    PrecursorIntensityID.95 = PrecursorIntensity95perc_ID,
                    PrecursorIntensityID.100 = maxPrecursorIntensity_ID)
QCmetrics <- rename(QCmetrics,
                    PrecursorMZID.0 = minPrecursorMZ_ID,
                    PrecursorMZID.5 = PrecursorMZ5perc_ID,
                    PrecursorMZID.25 = PrecursorMZ25perc_ID,
                    PrecursorMZID.50 = PrecursorMZ50perc_ID,
                    PrecursorMZID.75 = PrecursorMZ75perc_ID,
                    PrecursorMZID.95 = PrecursorMZ95perc_ID,
                    PrecursorMZID.100 = maxPrecursorMZ_ID)

QCmetrics <- rename(QCmetrics,
                    PrecursorMWID.0 = minPrecursorMW_ID,
                    PrecursorMWID.5 = PrecursorMW5perc_ID,
                    PrecursorMWID.25 = PrecursorMW25perc_ID,
                    PrecursorMWID.50 = PrecursorMW50perc_ID,
                    PrecursorMWID.75 = PrecursorMW75perc_ID,
                    PrecursorMWID.95 = PrecursorMW95perc_ID,
                    PrecursorMWID.100 = maxPrecursorMW_ID)

QCmetrics <- rename(QCmetrics,
                    MS2perMS1ID.0 = minMS2perMS1_ID,
                    MS2perMS1ID.5 = MS2perMS1_5perc_ID,
                    MS2perMS1ID.25 = MS2perMS1_25perc_ID,
                    MS2perMS1ID.50 = MS2perMS1_50perc_ID,
                    MS2perMS1ID.75 = MS2perMS1_75perc_ID,
                    MS2perMS1ID.95 = MS2perMS1_95perc_ID,
                    MS2perMS1ID.100 = maxMS2perMS1_ID)
QCmetrics <- rename(QCmetrics,
                    MS2chargeID.1 = MS2Charge1_ID,
                    MS2chargeID.2 = MS2Charge2_ID,
                    MS2chargeID.3 = MS2Charge3_ID,
                    MS2chargeID.4 = MS2Charge4_ID,
                    MS2chargeID.5andhigher = MS2Charge5_ID##MS2Charge5andHigher_ID,
                   )

# Adding Retention Time ID (Jiahao)
QCmetrics <- rename(QCmetrics,
                    RetentionTimeID.0 = minRetentionTime_ID,
                    RetentionTimeID.5 = RetentionTime5perc_ID,
                    RetentionTimeID.25 = RetentionTime25perc_ID,
                    RetentionTimeID.50 = RetentionTime50perc_ID,
                    RetentionTimeID.75 = RetentionTime75perc_ID,
                    RetentionTimeID.95 = RetentionTime95perc_ID,
                    RetentionTimeID.100 = maxRetentionTime_ID)


if ("MS2Charge0_ID" %in% colnames(QCmetrics)) {
    QCmetrics <- rename(QCmetrics,
                        MS2chargeID.0 = MS2Charge0_ID)
}


##Create data frame melting the precursor intensities
QCmetricsLongPrecInt_ID <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|PrecursorIntensityID\\.\\d+)$",
                                                colnames(QCmetrics))],
                             variable.name="PrecursorIntensityID",
                             value.name="value",
                             id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecInt_ID)
QCmetricsLongPrecInt_ID <- cbind(QCmetricsLongPrecInt_ID[,1:2],
                              colsplit(QCmetricsLongPrecInt_ID[,3], "\\.",
                                       c("PrecursorIntensityID","Percentile")),
                              QCmetricsLongPrecInt_ID[,4])
head(QCmetricsLongPrecInt_ID)
colnames(QCmetricsLongPrecInt_ID)[5] <- "value"

QCmetricsLongPrecInt_ID$`Analytical sample` <- QCmetricsLongPrecInt_ID$analyticalBasename
QCmetricsLongPrecInt_ID$Fraction <- QCmetricsLongPrecInt_ID$Fraction

##Create data frame melting the precursor MZ values
QCmetricsLongPrecMZ_ID <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|PrecursorMZID\\.\\d+)$",
                                               colnames(QCmetrics))],
                            variable.name="PrecursorMZID",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecMZ_ID)
QCmetricsLongPrecMZ_ID <- cbind(QCmetricsLongPrecMZ_ID[,1:2],
                             colsplit(QCmetricsLongPrecMZ_ID[,3], "\\.",
                                      c("PrecursorMZID","Percentile")),
                             QCmetricsLongPrecMZ_ID[,4])
head(QCmetricsLongPrecMZ_ID)
colnames(QCmetricsLongPrecMZ_ID)[5] <- "value"

QCmetricsLongPrecMZ_ID$`Analytical sample` <- QCmetricsLongPrecMZ_ID$analyticalBasename
QCmetricsLongPrecMZ_ID$Fraction <- QCmetricsLongPrecMZ_ID$Fraction

##Create data frame melting the precursor MW values
QCmetricsLongPrecMW_ID <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|PrecursorMWID\\.\\d+)$",
                                               colnames(QCmetrics))],
                            variable.name="PrecursorMWID",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongPrecMW_ID)
QCmetricsLongPrecMW_ID <- cbind(QCmetricsLongPrecMW_ID[,1:2],
                             colsplit(QCmetricsLongPrecMW_ID[,3], "\\.",
                                      c("PrecursorMWID","Percentile")),
                             QCmetricsLongPrecMW_ID[,4])
head(QCmetricsLongPrecMW_ID)
colnames(QCmetricsLongPrecMW_ID)[5] <- "value"

QCmetricsLongPrecMW_ID$`Analytical sample` <- QCmetricsLongPrecMW_ID$analyticalBasename
QCmetricsLongPrecMW_ID$Fraction <- QCmetricsLongPrecMW_ID$Fraction

##Create data frame melting the MS2perMS values
QCmetricsLongMS2perMS_ID <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|MS2perMS1ID\\.\\d+)$",
                                                 colnames(QCmetrics))],
                              variable.name=" MS2perMS1",
                              value.name="value",
                              id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongMS2perMS_ID)
QCmetricsLongMS2perMS_ID <- cbind(QCmetricsLongMS2perMS_ID[,1:2],
                               colsplit(QCmetricsLongMS2perMS_ID[,3], "\\.",
                                        c("MS2perMS1ID","Percentile")),
                               QCmetricsLongMS2perMS_ID[,4])
head(QCmetricsLongMS2perMS_ID)
colnames(QCmetricsLongMS2perMS_ID)[5] <- "value"

QCmetricsLongMS2perMS_ID$`Analytical sample` <- QCmetricsLongMS2perMS_ID$analyticalBasename
QCmetricsLongMS2perMS_ID$Fraction <- QCmetricsLongMS2perMS_ID$Fraction

##Create data frame melting MS2 charge ratio
QCmetricsLongMS2Charge_ID <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|MS2chargeID\\.\\d[a-z]*)$",
                                                  colnames(QCmetrics))],
                                    variable.name="MS2chargeID",
                                    value.name="value",
                                    id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsLongMS2Charge_ID)
QCmetricsLongMS2Charge_ID <- cbind(QCmetricsLongMS2Charge_ID[,1:2],
                                     colsplit(QCmetricsLongMS2Charge_ID[,3], "\\.", c("MS2chargeID","MS2ChargeState")),
                                     QCmetricsLongMS2Charge_ID[,4])
head(QCmetricsLongMS2Charge_ID)
colnames(QCmetricsLongMS2Charge_ID)[5] <- "value"
QCmetricsLongMS2Charge_ID$MS2chargeID <- NULL
totalMS2_ID = sum(QCmetricsLongMS2Charge_ID$value)
QCmetricsLongMS2Charge_ID$Chargeratio<- c(QCmetricsLongMS2Charge_ID$value/totalMS2_ID)

QCmetricsLongMS2Charge_ID$`Analytical sample` <- QCmetricsLongMS2Charge_ID$analyticalBasename
QCmetricsLongMS2Charge_ID$Fraction <- QCmetricsLongMS2Charge_ID$Fraction

# calculate the values for charge distribution for differnt cahrge state 
chargestateratio_ID <- c(sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == 1,select=c(Chargeratio))), sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == 2,select=c(Chargeratio))), sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == 3,select=c(Chargeratio))), sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == 4,select=c(Chargeratio))), sum(subset(QCmetricsLongMS2Charge_ID, MS2ChargeState == "5andhigher",select=c(Chargeratio))))
if (charge0avail) {
  chargestateratio_ID <- c(sum(subset(QCmetricsLongMS2Charge_ID,                                                                       MS2ChargeState == 0,select=c(Chargeratio))),chargestateratio_ID)
}

#generate the data frame contains the cahrge ratio (Jiahao)
Chargeratio_ID <- data.frame(chargestate, chargestateratio_ID)
Chargeratio_ID$`Proportion` <- round((Chargeratio_ID$chargestateratio_ID)*100,2)
Chargeratio_ALL$`Proportion` <- round((Chargeratio_ALL$chargestateratio_ALL)*100,2)

summary(Chargeratio_ALL)
summary(Chargeratio_ID)

# Create data frame melting Retention Time ID (Jiahao)
QCmetricsPeptideRT_ID <- melt(QCmetrics[,grep("^(analyticalBasename|Fraction|RetentionTimeID\\.\\d+)$",
                                              colnames(QCmetrics))],
                            variable.name="RetentionTimeID",
                            value.name="value",
                            id.vars=c("analyticalBasename","Fraction"))
head(QCmetricsPeptideRT_ID)
QCmetricsPeptideRT_ID <- cbind(QCmetricsPeptideRT_ID[,1:2],
                             colsplit(QCmetricsPeptideRT_ID[,3], "\\.",
                                      c("RetentionTimeID","Percentile")),
                             QCmetricsPeptideRT_ID[,4])
head(QCmetricsPeptideRT_ID)
colnames(QCmetricsPeptideRT_ID)[5] <- "value"

QCmetricsPeptideRT_ID$`Analytical sample` <- QCmetricsPeptideRT_ID$analyticalBasename
QCmetricsPeptideRT_ID$Fraction <- QCmetricsPeptideRT_ID$Fraction
```

```{r, include=FALSE}
# Cleaning the Summary data
col_selection <- grepl(".Unshared.Peptides$", names(SUmetrics))

Spectral_table <- SUmetrics[ , col_selection, drop=FALSE ]
colnames(Spectral_table) <- sub(".Unshared.Peptides$","",colnames(Spectral_table))

id_protein <- Spectral_table[ , , drop=FALSE ] >= 2

df1 = subset(expdes1, select=c('analyticalsampleascolumn','analyticalsample','analyticalsampleordinalstr','analyticalsampleordinal'))
df1 <- df1[!duplicated(df1),]
df1 <- df1[order(df1$analyticalsampleordinal),]

id_protein <- id_protein[,df1$analyticalsampleascolumn,drop=FALSE]

cum_id_protein <- id_protein
all_id_protein <- id_protein
if (ncol(cum_id_protein)>1) {
  for(i in 2:ncol(cum_id_protein)) {
    cum_id_protein[,i] = (cum_id_protein[,i]|cum_id_protein[,(i-1)])
    all_id_protein[,i] = (all_id_protein[,i]&all_id_protein[,(i-1)])
  }
}

id_protein <- data.frame(colSums(id_protein))
cum_id_protein <- data.frame(colSums(cum_id_protein))
all_id_protein <- data.frame(colSums(all_id_protein))
colnames(id_protein) <- "ProteinCounts"
colnames(cum_id_protein) <- "ProteinCounts"
colnames(all_id_protein) <- "ProteinCounts"

id_protein$Proteins <- id_protein$ProteinCounts
cum_id_protein$Proteins <- cum_id_protein$ProteinCounts
all_id_protein$Proteins <- all_id_protein$ProteinCounts

# QCmetrics$analyticalBasenameFactor <- factor(QCmetrics$analyticalBasenameLabel,levels=orderedabs,ordered=TRUE)
# QCmetrics$analyticalBasenameIndex <- as.numeric(QCmetrics$analyticalsampleordinal)
# QCmetrics$analyticalBasename <- sprintf("%02d",QCmetrics$analyticalBasenameIndex)


# id_protein$analyticalBasenameFactor <- factor(id_protein$analyticalBasenameLabel,levels=orderedabs,ordered=TRUE)
# id_protein$analyticalBasenameIndex <- as.numeric(id_protein$analyticalBasenameFactor)
id_protein$analyticalBasenameLabel <- make.names(rownames(id_protein))
id_protein <- merge(id_protein, df1, by.x='analyticalBasenameLabel', by.y='analyticalsampleascolumn', suffixes=c("","expdes"))
id_protein <- id_protein[order(id_protein$analyticalsampleordinal),]

cum_id_protein$analyticalBasenameLabel <- make.names(rownames(cum_id_protein))
cum_id_protein <- merge(cum_id_protein, df1, by.x='analyticalBasenameLabel', by.y='analyticalsampleascolumn', suffixes=c("","expdes"))
cum_id_protein <- cum_id_protein[order(cum_id_protein$analyticalsampleordinal),]

all_id_protein$analyticalBasenameLabel <- make.names(rownames(all_id_protein))
all_id_protein <- merge(all_id_protein, df1, by.x='analyticalBasenameLabel', by.y='analyticalsampleascolumn', suffixes=c("","expdes"))
all_id_protein <- all_id_protein[order(all_id_protein$analyticalsampleordinal),]

id_protein$analyticalBasename <- id_protein$analyticalsample
cum_id_protein$analyticalBasename <- cum_id_protein$analyticalsample
all_id_protein$analyticalBasename <- all_id_protein$analyticalsample

id_protein$analyticalBasenameIndex <- id_protein$analyticalsampleordinal
cum_id_protein$analyticalBasenameIndex <- cum_id_protein$analyticalsampleordinal
all_id_protein$analyticalBasenameIndex <- all_id_protein$analyticalsampleordinal

id_protein$analyticalBasenameIndexStr <- id_protein$analyticalsampleordinalstr
cum_id_protein$analyticalBasenameIndexStr <- cum_id_protein$analyticalsampleordinalstr
all_id_protein$analyticalBasenameIndexStr <- all_id_protein$analyticalsampleordinalstr

id_protein$`Analytical sample` <- id_protein$analyticalBasenameIndex
cum_id_protein$`Analytical sample` <- cum_id_protein$analyticalBasenameIndex
all_id_protein$`Analytical sample` <- all_id_protein$analyticalBasenameIndex

# mylog(id_protein)

total_p <- nrow(Spectral_table)
```

```{r, include=FALSE}
# Cleaning the TMT10 data
raw_edata <- read.table(tmt10_file, header=TRUE, sep="\t", row.names=1, quote="")

# Subset the raw metrics 

# Ratio header 1, Typical Study, w/ POOL:
us_selection <- grepl("\\.Unshared\\.Log\\.Ratio$", names(raw_edata), perl = TRUE)
s_selection <- grepl("\\.Log\\.Ratio$", names(raw_edata), perl = TRUE)
s_selection <- (s_selection&(!(us_selection)));
samples_ratios = 'Biological Samples'

# Ratio header 2, CompRef:
if (sum(s_selection,na.rm=TRUE) == 0) {
  us_selection <- grepl("^Unshared\\.Log\\.", names(raw_edata), perl = TRUE)
  s_selection <- grepl("^Log\\.", names(raw_edata), perl = TRUE)
  samples_ratios = 'Computed Ratios'
}

# Spectral counts headers:
if (sum(s_selection,na.rm=TRUE) == 0) {    
  not_selection <- grepl("^Total\\.", names(raw_edata), perl = TRUE)
  us_selection <- grepl("\\.Unshared\\.Spectral\\.Counts$", names(raw_edata), perl = TRUE)
  s_selection <- grepl("\\.Spectral\\.Counts$", names(raw_edata), perl = TRUE)
  s_selection <- (s_selection&(!(us_selection)));
  s_selection <- (s_selection&(!(not_selection)));
  us_selection <- (us_selection&(!(not_selection)));
  samples_ratios = 'Biological Samples'
}

if (sum(us_selection,na.rm=TRUE) > 0) {
  stopifnot(sum(s_selection,na.rm=TRUE) == sum(us_selection,na.rm=TRUE))
}

if (sum(grepl("^Median$",rownames(raw_edata))) > 0) {
  s_metrics <- tail(raw_edata[,s_selection,drop=FALSE], -3)
} else if (sum(grepl("^Total$",rownames(raw_edata))) > 0) {
  s_metrics <- head(raw_edata[,s_selection,drop=FALSE], -1)
} else {
  s_metrics <- raw_edata[,s_selection,drop=FALSE]
}

orig_s_metrics <- s_metrics

colnames(s_metrics) <- sub("\\.Unshared\\.Log\\.Ratio$", '', colnames(s_metrics))
colnames(s_metrics) <- sub("\\.Log\\.Ratio$", '', colnames(s_metrics))
colnames(s_metrics) <- sub("\\.Unshared\\.Spectral\\.Counts$", '', colnames(s_metrics))
colnames(s_metrics) <- sub("\\.Spectral\\.Counts$", '', colnames(s_metrics))
colnames(s_metrics) <- sub("^Unshared\\.Log\\.", '', colnames(s_metrics))
colnames(s_metrics) <- sub("^Log\\.", '', colnames(s_metrics))

if (params$dochecks) {
  mylog(expdes1$sampleascolumn)
  mylog(colnames(s_metrics))
  stopifnot(setequal(expdes1$sampleascolumn,colnames(s_metrics)))
}

# min_samples_per_analyticalsample = 100
# max_samples_per_analytcialsample = 0
# analyticalsamples = colnames(Spectral_table)
# for(i in 1:length(analyticalsamples)){
    # 
# }
# as.integer(ncol(s_metrics)/ncol(Spectral_table))
# 
# Clean the metrics (remove NAs in s_metrics, keep ref_metrics as reference)
# mylog(s_metrics)
ref_metrics <- s_metrics
s_metrics <- s_metrics[complete.cases(s_metrics),,drop=FALSE]


# Construct pheno metrics (s_metrics)
# s_sample <- colnames(s_metrics)
# s_x <- c(1:(ncol(s_metrics)/samples_per_analyticalsample))
# s_batch <- rep(s_x, each=samples_per_analyticalsample)
# s_pheno <- data.frame(s_sample, s_batch, row.names=1)
# s_pheno$s_batch <- sprintf("%02d",s_pheno$s_batch)
# batch = as.factor(s_pheno$s_batch)
#View(s_pheno)

# Compute NAs in ref_metrics for PCA
# for(i in 1:nrow(ref_metrics)){
#   ref_metrics[i, is.na(ref_metrics[i,])] <- min(ref_metrics[i,], na.rm = TRUE)
# }

# Take only the complete rows.
ref_metrics <- s_metrics;

# mylog(s_metrics)

if (samples_ratios == "Biological Samples") {
  expdes1$sampleratios <- sprintf("%s/COMMON_INTERNAL_REFERENCE_SAMPLE",expdes1$sample)
}
outexpdes1 <- subset(expdes1, select=c(analyticalsampleordinal,analyticalsample,ratioordinal,labelratios,sampleratios))
names(outexpdes1) <- c("AnalyticalSampleIndex","AnalyticalSample","IsobaricLabelRatioIndex","IsobaricLabelRatio","SampleRatio")
write.table(outexpdes1, file=outexpdes_file, row.names=FALSE, sep="\t", quote = FALSE)

```

```{r,include=FALSE}
# generating a color Palettes for ggvis 
# plotColorPalettes is the function for generating the pallettes, the colors in the palettes depends on the number we put in 
# in our case, the palettes is called plotcolor

plotColorPalettes <- function(g){
  d <- 360/g
  h <- cumsum(c(15, rep(d,g - 1)))
  hcl(h = h, c = 100, l = 65)
}
plotcolor <- plotColorPalettes(length(analyticalSamples)) # the number of colors is the same as how many analytical smples in the data. 

# Create color palette for isobaric label 
# iso_color = brewer.pal(samples_per_analyticalsample, 'Paired')
iso_color = plotColorPalettes(number_of_numerator_labels)
```

```{r include=FALSE}
all_spect_title <- list(
  text = "All MS/MS Spectra",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1,
  showarrow = FALSE
)

id_spect_title <- list(
  text = "Identified MS/MS Spectra",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1,
  showarrow = FALSE
)

all_spect_title_grid <- list(
  text = "All MS/MS Spectra",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.15,
  showarrow = FALSE
)

id_spect_title_grid <- list(
  text = "Identified MS/MS Spectra",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.15,
  showarrow = FALSE
)

# Add new layout annotation for MS/MS Distinct Peptides for Fractions by Analytical Sample (Jiahao)
peptide_title <- list(
  text = "Distinct Peptides",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.0,
  showarrow = FALSE
)

as_title <- list(
  text = "Analytical Sample",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "top",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = -0.1,
  showarrow = FALSE
)

fr_title <- list(
  text = "Fraction",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "top",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = -0.1,
  showarrow = FALSE
)

# Add new layout annotation for Redundancy
peptide_rd <- list(
  text = "Peptide Redundancy",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.12,
  showarrow = FALSE
)

# Add new layout annotation for Identified Protein
protein_title <- list(
  text = "Identified Proteins",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.0,
  showarrow = FALSE
)

# Add new layout annotation for PCA
pca_title <- list(
  text = "PCA",
  ##font = f,
  xref = "paper",
  yref = "paper",
  yanchor = "bottom",
  xanchor = "center",
  align = "left",
  x = 0.5,
  y = 1.0,
  showarrow = FALSE
)
```

```{r, include=FALSE}
grid_arrange_shared_legend <- function(..., ncol = length(list(...)), nrow = 1, position = c("bottom", "right")) {

  plots <- list(...) 
  position <- match.arg(position)
  g <- ggplotGrob(plots[[1]] +theme(legend.position = position))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  lwidth <- sum(legend$width)
  gl <- lapply(plots, function(x) x + theme(legend.position="none"))
  gl <- c(gl, ncol = ncol, nrow = nrow)

  combined <- switch(position,
                     "bottom" = arrangeGrob(do.call(arrangeGrob, gl),
                                            legend,
                                            ncol = 1,
                                            heights = unit.c(unit(1, "npc") - lheight, lheight)),
                     "right" = arrangeGrob(do.call(arrangeGrob, gl),
                                           legend,
                                           ncol = 2,
                                           widths = unit.c(unit(1, "npc") - lwidth, lwidth)))
  grid.newpage()
  grid.draw(combined)
  # return gtable invisibly
  invisible(combined)

}

```

```{r}

# make a function to compute the max and min value 
##  Only useful for those has different percentiles
### n and m represent 2 differnt data frame that you want to compare with

find_max<-function(n, m)
{
  max_n <- max(max(subset(n, Percentile <= 95,select=c(value))), max(subset(m, Percentile <= 95,select=c(value))))
  return(max_n)
}

#find_max(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID)

find_min <- function(n,m)
{
  min_n <- min(min(subset(n, Percentile <= 95,select=c(value))), min(subset(m, Percentile <= 95,select=c(value))))
  return(min_n)
}

# create title for each of the plot (Jiahao)
title_ALL <- "All MS/MS Spectra" 
title_ID <-  "Identified MS/MS Spectra"

#find_min(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID)
```

```{r}

# Build a function for generating the a table with 
## we have 2 parameter one is the kind we want for rows and the other is the dataframe we are sing to generate the table 

##remember to put the "" mark, it only has 2 choices one is fraction and the other one is analytical samples, each kind will generate a pre-determined table

# when kind ==  fraction meaning we are geneating plots whose rows are fractions, like the table of 0 for precursor intensity 

# when kind == analytical sample the rows will be sample names like the table for the percentage of samples under 20 in MS2 per MS2 value

percentage_table <- function(kind, n)
{
  
  B=c(5,25,50,75,95)
  
  # generate a dataframe
  num_row <-  as.numeric(count(unique(select(n, contains(kind)))))
  
  if(kind=="fraction")
  {
    perc_table = matrix(,nrow = length(fractions), ncol = length(B))
  } else 
  {
    if(kind=="analytical")
    {
      perc_table = matrix(,nrow = length(analyticalSamples), ncol = length(B))
    }
  }
  
  if(kind == "fraction"){
    for (i in 1:nrow(perc_table)){
      for (j in 1:length(B)){
        if(sum(n$Fraction == i) > 0)
        {
          perc_table[i,j]<-round(length(which(n$Percentile == B[j] & n$Fraction == i))/length(which(QCmetricsLongPrecInt_ALL$Fraction == i &QCmetricsLongPrecInt_ALL$Percentile == B[j]))*100, 
                                 3)
        }
        else
        {
          perc_table[i,j]<- 0
        }
        
      }
    }
    colnames(perc_table) <- c("5th Perc", "25th Perc", "50th Perc", "75th Perc","95th Perc")
    rownames(perc_table) <- c(paste0("fraction", 1:24))##c(1:25)))
    kable(perc_table)# %>% kable_styling(bootstrap_options = "striped", full_width = F)
    
  }else 
  {
    if(kind == "analytical"){
      for (i in 1:length(analyticalSamples)){
        for(j in 1:length(B)){
          perc_table[i,j] <- round(length(which(n$Percentile == B[j] & n$value <20 & n$analyticalBasename == analyticalSamples[i] ))/ length(which(n$Percentile == B[j] & n$analyticalBasename == analyticalSamples[i]))*100,
                                   3)
        }
      }
      colnames(perc_table) <- c(paste0(B, rep("th Perc", 5)))
      rownames(perc_table) <- c(as.character(analyticalSamples))
      kable(perc_table, caption = "Percent of samples' value less than 20") #%>%
      # kable_styling(bootstrap_options = "striped") 
    }
  }
}

#percentage_table("fraction",QCPrecIntof0_ALL )
```  

```{r}

space_labels <- function(nvalues,maxpoints) {
  if (maxpoints == 0) {
    maxpoints = 10000;
    # mylog(c(nvalues,maxpoints,1:nvalues))
    return(1:nvalues)
  }
  spacing = 0
  npoints = 0
  for (d in c(1,5,10,20,50)) {
    npoints = floor(nvalues/d)
    if (d*npoints < nvalues & (nvalues - d*npoints) >= ceiling(d/2)  ) {
      npoints = npoints + 1
    }
    if (d != 1) {
      npoints = npoints + 1
    }
    if (npoints <= maxpoints) {
      spacing = d
      break
    }
  }
  # mylog(c(spacing,npoints))
  if (nvalues >= 5 & npoints <= 3 & maxpoints >= 3) {
    # mylog(c(nvalues,maxpoints,c(1,ceiling(nvalues/2),nvalues)))
    return(c(1,ceiling(nvalues/2),nvalues))
  }
  if (floor(nvalues/spacing) == 0) {
    # mylog(c(nvalues,maxpoints,c(1,nvalues)))
    return(c(1,nvalues))
  }
  points = spacing*(1:floor(nvalues/spacing))
  if (points[1] != 1) {
    points = c(1,points)
  }
  if (points[length(points)] < nvalues) {
    if ((nvalues - points[length(points)]) >= ceiling(spacing/2)) {
      points = c(points,nvalues)
    } else {
      points[length(points)] = nvalues
    }
  }
  # mylog(c(nvalues,maxpoints,points))
  points
}

# Define plot function (Jiahao)
gg_points <- function(data, y_string, x_string,
                      col_string, label_string, label2_string="",
		      min_y=NULL, max_y=NULL, 
	              sparse_x_labels=0)
{
  if (label2_string == "") {
    label2_string = y_string;
  }
  data.original.level=sort(as.vector(unique(data[, x_string])))
  new.break.points = space_labels(length(data.original.level),sparse_x_labels)
  # break.points=1:length(data.original.level)
  # new.break.points=break.points
  # if(length(break.points)>(sparse_x_labels) && sparse_x_labels>0){
  #   divisor=ceiling(length(break.points)/sparse_x_labels)
  #  max.x=length(break.points)-max(ceiling(divisor/2),2)
  #  # max.x=divisor*sparse_x_labels
  #  # max.x=length(break.points)
  #   new.break.points=break.points[seq(from=1,to=max.x, by=divisor)]
  #   if(new.break.points[length(new.break.points)]<max(break.points)) new.break.points=c(new.break.points, max(break.points))
  # }
  b <- ggplot(data, aes_string(y=y_string, 
                               x=x_string, 
        	               col=col_string, 
                               label=label_string, 
                               label2=label2_string)) +
       geom_point() +
       scale_x_continuous(breaks = data.original.level[new.break.points], 
                          labels = data.original.level[new.break.points]) + 
       theme(# axis.title.x=element_blank(),
             plot.margin = margin(0.2, 0.5, 0.2, 0, "cm"),
             # axis.text.x=element_blank(),
             legend.position="none")
  if (!is.null(min_y) && !is.null(max_y)) {
      b <- b + ylim(min_y,max_y)
  } else if (!is.null(min_y)) {
      b <- b + ylim(min_y,NA)
  } else if (!is.null(max_y)) {
      b <- b + ylim(NA,max_y)
  }
  b
}

gg_box <- function(data, y_string, x_string,
                   col_string, label_string, label2_string="Fraction",
                   same_scale=FALSE, min_y=NULL, max_y=NULL,sparse_x_labels=0)
{
  data.original.level=sort(as.vector(unique(data[, x_string])))
  new.break.points = space_labels(length(data.original.level),sparse_x_labels)
  # break.points=1:length(data.original.level)
  # new.break.points=break.points
  # if(length(break.points)>(sparse_x_labels+1) & sparse_x_labels>0){
  #   divisor=floor(length(break.points)/sparse_x_labels)
  #   max.x=length(break.points)-max(ceiling(divisor/2),2)
  #   # max.x=divisor*sparse_x_labels
  #   new.break.points=break.points[seq(from=1,to=max.x, by=divisor)]
  #   if(new.break.points[length(new.break.points)]<max(break.points)) new.break.points=c(new.break.points, max(break.points))
  # }

  b <- ggplot(data, aes_string(y=y_string, x=x_string, 
                               col=col_string, label=label_string,
                               label2=label2_string)) +
    geom_boxplot()+
    geom_point(alpha=0.6) +
    scale_x_continuous(breaks = data.original.level[new.break.points], 
                       labels = data.original.level[new.break.points]) + 
    theme(axis.title.x=element_blank(),
          plot.margin = margin(0.2, 1.0, 0.2, 0, "cm"),
          # axis.text.x=element_blank(),
          legend.position="none")
  if(same_scale)
  {
      b <- b+ylim(min_y, max_y)
  } else if (!is.null(min_y) && !is.null(max_y)) {
      b <- b + ylim(min_y,max_y)
  } else if (!is.null(min_y)) {
      b <- b + ylim(min_y,NA)
  } else if (!is.null(max_y)) {
      b <- b + ylim(NA,max_y)
  }
  b
}

gg_points_frac <- function(data, y_string, x_string,
                           col_string, label_string, label2_string="Fraction",
                           smooth=FALSE,boxplot=FALSE,                   
                           same_scale=FALSE, min_y=NULL, max_y=NULL, sparse_x_labels=0)
{
  x_stringlab <- x_string
  x_stringval <- paste0(x_string,"Index")

  break.points=sort(as.numeric(unique(data[, x_stringval])))
  new.break.points = space_labels(length(break.points),sparse_x_labels)
  new.break.points = break.points[new.break.points]
  # new.break.points=break.points
  # if(length(break.points)>(sparse_x_labels+1) && sparse_x_labels>0){
  #   divisor=floor(length(break.points)/sparse_x_labels)
  #   max.x=length(break.points)-max(ceiling(divisor/2),2)
  #   # max.x=divisor*sparse_x_labels
  #   new.break.points=break.points[seq(from=1,to=max.x, by=divisor)]
  #   if(new.break.points[length(new.break.points)]<max(break.points)) new.break.points=c(new.break.points, max(break.points))
  # }
  new.break.point.labels = fraclabs$ufraclab[fraclabs$fracindex %in% new.break.points];

  pf <- 
 
     ggplot(data, aes_string(y=y_string, x=x_stringval, 
                                label=label_string,
                                label2=label2_string
                                ))   +   
    scale_x_continuous(breaks = new.break.points, labels = new.break.point.labels) +
    theme(axis.title.x=element_blank(),
          axis.title.y=element_blank(), 
          plot.margin = margin(0.2, 1.0, 0.2, 0, "cm"),
          legend.position="none")    
      
  if(same_scale)
  {
      pf <- pf+ylim(min_y, max_y)
  } else if (!is.null(min_y) && !is.null(max_y)) {
      pf <- pf + ylim(min_y,max_y)
  } else if (!is.null(min_y)) {
      pf <- pf + ylim(min_y,NA)
  } else if (!is.null(max_y)) {
      pf <- pf + ylim(NA,max_y)
  }

  if(boxplot)
  {
    pf <- pf+geom_boxplot()
  }
  if(smooth && 0)
  {
    pf <- (pf+stat_smooth(aes_string(y=y_string, x=x_stringval, col=col_string),
                         method="loess", fill="grey50", size=0))
  }
  pf + geom_point(aes_string(col=col_string))
}

gg_points_frac_perc <- function(data, y_string, x_string,
                                col_string, group_string,
                                label_string, 
				label2_string="Fraction",
                                boxplot=FALSE,
                                same_scale=TRUE, min_y=NULL, max_y=NULL,sparse_x_labels=0)
{
  
  data <- merge(data,fraclabs,by.x="Fraction",by.y="ufraclab")
  data$FractionIndex <- data$fracindex
  data$fracindex <- NULL
  data$fracnum <- NULL
  x_stringval = paste0(x_string,"Index")
  
  break.points=sort(as.numeric(unique(data[, x_stringval])))
  new.break.points = space_labels(length(break.points),sparse_x_labels)
  new.break.points = break.points[new.break.points]

  # new.break.points=break.points
  # if(length(break.points)>(sparse_x_labels+1)&&sparse_x_labels>0){
  #   divisor=floor(length(break.points)/sparse_x_labels)
  #   max.x=length(break.points)-max(ceiling(divisor/2),2)
  #   # max.x=divisor*sparse_x_labels
  #   new.break.points=break.points[seq(from=1,to=max.x, by=divisor)]
  #   if(new.break.points[length(new.break.points)]<max(break.points)) new.break.points=c(new.break.points, max(break.points))
  # }
  new.break.point.labels = fraclabs$ufraclab[fraclabs$fracindex %in% new.break.points]

  pfc <- 
     ggplot(data, 
                  aes_string(y=y_string, x=x_stringval, 
                             col=col_string, group=group_string,
                             label=label_string, label2=label2_string)) + 
        facet_grid(~ Percentile)   +
        scale_x_continuous(breaks = new.break.points, labels=new.break.point.labels) +
        theme(plot.margin = margin(0.2, 1.0, 0.2, 0, "cm"), panel.spacing.x = unit(2, "lines")) #change 
    
  
  if(same_scale){
    pfc <- pfc +  ylim(min_y,max_y)
  }  
  if(boxplot){
    pfc <- pfc + geom_boxplot() +
      theme(axis.title.x=element_blank(),
      #      axis.text.x=element_blank(),
            legend.position="none")
  } else {
    pfc <- pfc +
      theme(legend.position = "none")
  }
  pfc + geom_point(aes_string(col=col_string), alpha=0.6, size=0.9)
}

# Add ggbars
gg_bars <- function(data, y_string, x_string, col_string, label_string)
{
  ggplot(data, aes_string(y=y_string, x=x_string, fill=col_string, label=label_string)) +
  geom_bar(stat = "identity") +
  theme(axis.title.x=element_blank(),
        plot.margin = margin(0.2, 0.5, 0.2, 0, "cm"),
        # axis.text.x=element_blank(),
        legend.title = element_blank()
)
}
```

<P/>

# - Study Files

```{r echo=FALSE}
headers = c("Experimental Design",
	    "Protein Summary",
	    "Protein Relative Quant.",
	    "Peptide Summary",
            "Metrics")
values =   c(paste0("<a href=",basename(outexpdes_file)," target=\"_blank\"><b>",basename(outexpdes_file),"</b></a>",sep=""),
	     paste0("<a href=",basename(Summary_file)," target=\"_blank\"><b>",basename(Summary_file),"</b></a>",sep=""),
             paste0("<a href=",basename(tmt10_file)," target=\"_blank\"><b>",basename(tmt10_file),"</b></a>",sep=""),
             paste0("<a href=",basename(Peptide_file)," target=\"_blank\"><b>",basename(Peptide_file),"</b></a>",sep=""),
             paste0("<a href=",basename(QCmetrics_file)," target=\"_blank\"><b>",basename(QCmetrics_file),"</b></a>",sep=""))

summary_table <- matrix(values, ncol = 1)
rownames(summary_table) <- headers
kable(summary_table, align = 'l',escape=FALSE) %>% kable_styling(bootstrap_options = c("striped","hover"),full_width = F, position="left") %>% column_spec(1, bold = T) 

```
# - Study Summary

```{r echo=FALSE}

# number of analytical samples
nAnalyticalSamples = length(unique(QCmetrics$analyticalBasename))

# Fractions per analytical sample
nFractionsPerAS = length(unique(QCmetrics$Fraction))

# Number of spectral datafiles
nFiles = nrow(QCmetrics)

# Number of replicates
t3 = table(QCmetrics$analyticalBasename,QCmetrics$Fraction)
nRepsPerFrac = max(t3)
nRepsPerFracMin = min(t3)

# Check!
if (params$dochecks) {
  mylog(c(nFiles,(nAnalyticalSamples * nFractionsPerAS * nRepsPerFrac),nAnalyticalSamples,nFractionsPerAS,nRepsPerFrac))
  stopifnot(nFiles == (nAnalyticalSamples * nFractionsPerAS * nRepsPerFrac))
}

# proteins identified
nProteins = nrow(SUmetrics)
nProteins1 = cum_id_protein[nrow(all_id_protein),1]
nCommonProteins = all_id_protein[nrow(all_id_protein),1]

protfdr = as.character(MYmetrics[[5]])
protfdr = paste0(as.character(round(as.numeric(substr(protfdr,1,nchar(protfdr)-1)),2)),"%")

# peptides identified? 
nPeptides = length(unique(PEmetrics$Peptide))

# Ratios computed / Typically "samples" in CPTAC studies
nSamples = ncol(s_metrics)
nCompleteObs = nrow(s_metrics)

nSamplesPerAS = samples_per_analyticalsample

if (params$dochecks) {
  mylog(c(nSamples,nSamplesPerAS * nAnalyticalSamples,nSamplesPerAS,nAnalyticalSamples))
  stopifnot(nSamplesPerAS * nAnalyticalSamples == nSamples)
}

# Samples per analytical sample: samples_per_analyticalsample 
if (min_samples_per_analyticalsample != samples_per_analyticalsample) {
    nSamplesPerAS = sprintf("%s-%s",min_samples_per_analyticalsample,samples_per_analyticalsample);
}

# Check!
nMSMSSpectra = sum(QCmetrics$numofMS2_ALL)
nMSMSSpectraID = sum(QCmetrics$numofMS2_ID)

if (regexpr("\\.tmt10(-raw)?\\.tsv$",tmt10_file) != -1) {
    protocol = 'TMT-10'
} else if (regexpr("\\.tmt11(-raw)?\\.tsv$",tmt10_file) != -1) {
    protocol = 'TMT-11'
} else if (regexpr("\\.tmt6(-raw)?\\.tsv$",tmt10_file) != -1) {
    protocol = 'TMT-6'
} else if (regexpr("\\.tmt16(-raw)?\\.tsv$",tmt10_file) != -1) {
    protocol = 'TMT-16'
} else if (regexpr("\\.tmt18(-raw)?\\.tsv$",tmt10_file) != -1) {
    protocol = 'TMT-18'
} else if (regexpr("\\.itraq\\.tsv$",tmt10_file) != -1) {
    protocol = 'iTRAQ-4'
} else if (regexpr("\\.spectral_counts\\.tsv$",tmt10_file) != -1) {
    protocol = 'Label-free'
}

if (regexpr("\\.phospho",tmt10_file) != -1) {
    proteome = "Phosphoproteome"
    # Assumes we have phosphosites as the quantitation file
    nPhosphoSites = nrow(orig_s_metrics)
    # mylog(tmt10_file)
    stopifnot(regexpr("\\.phosphosite\\.",tmt10_file)>=0)
} else if (regexpr("\\.acetyl",tmt10_file) != -1) {
    proteome = "Acetylome"
    # Assumes we have acetylsites as the quantitation file
    nAcetylSites = nrow(orig_s_metrics)
    # mylog(tmt10_file)
    stopifnot(regexpr("\\.acetylsite\\.",tmt10_file)>=0)
} else if (regexpr("\\.ubiquityl",tmt10_file) != -1) {
    proteome = "Ubiquitylome"
    # Assumes we have ubisites as the quantitation file
    nUbiSites = nrow(orig_s_metrics)
    # mylog(tmt10_file)
    stopifnot(regexpr("\\.ubiquitylsite\\.",tmt10_file)>=0)
} else if (regexpr("\\.glyco",tmt10_file) != -1) {
    proteome = "Glycoproteome"
    # Assumes we have glycosites as the quantitation file
    nGlycoSites = nrow(orig_s_metrics)
    # mylog(tmt10_file)
    stopifnot(regexpr("\\.glycosite\\.",tmt10_file)>=0)
} else {
    proteome = "Whole Proteome"
}

headers = c(samples_ratios,
	    "Quantiation Workflow",
	    "Analytical Fraction",
	    paste(samples_ratios,"per Analytical Sample"),
            "Analytical Samples",
	    "Fractions per Analytical Sample",
            "Spectral Datafiles",
	    "MS/MS Spectra",
	    "Identified MS/MS Spectra (1% FDR)",
	    "Peptides",
	    paste0("Proteins"," (",protfdr," FDR)"))
values =   c(nSamples,
	     protocol,
	     proteome,
	     nSamplesPerAS,
	     nAnalyticalSamples,
	     nFractionsPerAS,
	     prettyNum(nFiles,big.mark=",",scientific=FALSE),
	     prettyNum(nMSMSSpectra,big.mark=",",scientific=FALSE),
	     prettyNum(nMSMSSpectraID,big.mark=",",scientific=FALSE),
	     prettyNum(nPeptides,big.mark=",",scientific=FALSE),
	     prettyNum(nProteins,big.mark=",",scientific=FALSE))

if (proteome == "Phosphoproteome") {
  headers <- append(headers,c("Phosphosites"),after=9);
  values <- append(values,c(prettyNum(nPhosphoSites,big.mark=",",scientific=FALSE)),after=9);
} else if (proteome == "Acetylome") {
  headers <- append(headers,c("Acetylsites"),after=9);
  values <- append(values,c(prettyNum(nAcetylSites,big.mark=",",scientific=FALSE)),after=9);
} else if (proteome == "Ubiquitylome") {
  headers <- append(headers,c("Ubiquitylsites"),after=9);
  values <- append(values,c(prettyNum(nUbiSites,big.mark=",",scientific=FALSE)),after=9);
} else if (proteome == "Glycoproteome") {
  headers <- append(headers,c("Glycosites"),after=9);
  values <- append(values,c(prettyNum(nGlycoSites,big.mark=",",scientific=FALSE)),after=9);
}

if (nRepsPerFrac > 1 | nRepsPerFracMin < 1) {
  headers <- append(headers,c("Replicates per Fraction"),after=6)
  if (nRepsPerFracMin == nRepsPerFrac) {
    values <- append(values,c(nRepsPerFrac),after=6)
  } else {
    values <- append(values,c(sprintf("%s-%s",nRepsPerFracMin,nRepsPerFrac)),after=6)
  }
}

summary_table <- matrix(values, ncol = 1)
rownames(summary_table) <- headers
kable(summary_table, align = 'r') %>% kable_styling(bootstrap_options = c("striped","hover"),full_width = F, position="left") %>% column_spec(1, bold = T) 

```
# - Analytical Samples
```{r echo=FALSE,results='asis'}
t <- table(QCmetrics$analyticalBasenameIndex)
df1 = data.frame(analyticalBasenameIndex=QCmetrics$analyticalBasenameIndex,
                 fractionIndex=QCmetrics$FractionIndex)
t2 = table(df1$analyticalBasenameIndex,df1$fractionIndex)
maxreps = apply(t2, 1, FUN = max)
t2[t2==0] = 10000000 # this is a HACK!
minreps = apply(t2, 1, FUN = min)
df1 = df1[!duplicated(df1),]
t1 = table(df1$analyticalBasenameIndex)
t3 = table(expdes1$analyticalsampleordinal)
if (FALSE & (nRepsPerFrac == 1) & (nRepsPerFracMin == 1)) {
    mat_t <- matrix(NA, ncol=4, nrow=length(levels(QCmetrics$analyticalBasenameFactor)))
    mat_t[,1] <- sort(unique(QCmetrics$analyticalBasename))
    mat_t[,2] <- levels(QCmetrics$analyticalBasenameFactor)
    mat_t[,4] <- as.matrix(t1)[,1]
    mat_t[,3] <- as.matrix(t3)[,1]
    if (samples_ratios == "Biological Samples") {
        colnames(mat_t) <- c("Index","Analytical Sample", "Samples", "Fractions")
    } else {
        colnames(mat_t) <- c("Index","Analytical Sample", "Ratios", "Fractions")
    }
} else {
    mat_t <- matrix(NA, ncol=6, nrow=length(levels(QCmetrics$analyticalBasenameFactor)))
    # mat_t[,1] <- sprintf("%02d",1:length(levels(QCmetrics$analyticalBasenameFactor)))
    mat_t[,1] <- unique(expdes1$analyticalsampleordinal)
    mat_t[,2] <- levels(QCmetrics$analyticalBasenameFactor)
    mat_t[,4] <- as.matrix(t1)[,1]
    mat_t[,3] <- as.matrix(t3)[,1]
    mat_t[,5] <- as.matrix(maxreps)[,1]
    for (i in 1:range(length(maxreps))) {
        if (minreps[i] != maxreps[i]) {
            mat_t[i,5] = sprintf("%s-%s",minreps[i],maxreps[i])
        }
    }
    mat_t[,6] <- as.matrix(t)[,1]
    if (samples_ratios == "Biological Samples") {
        colnames(mat_t) <- c("Index","Analytical sample","Samples","Fractions","Replicates","Files")
    } else {
        colnames(mat_t) <- c("Index","Analytical sample","Ratios","Fractions","Replicates","Files")
    }
}
kable(mat_t, align="rlrrrr") %>% kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE, position="left")
```

# - Proteins 

## - Proteins by Analytical Sample

Number of identified proteins by analytical sample. 

```{r, fig.height=3.3, fig.width=9.1}
# Generate the Plot 
g_id_protein <- gg_points(id_protein, 
                          y_string="ProteinCounts", x_string="analyticalBasenameIndex",
                          col_string="analyticalBasenameIndexStr", label_string="`Analytical sample`",label2_string="Proteins",min_y=0,sparse_x_labels=20)
p_id_protein <- ggplotly(g_id_protein, tooltip=c("label","label2")) %>% layout(annotations=protein_title) %>% layout(annotations=as_title)

subplot(p_id_protein, margin=0.05)##, titleX=TRUE, titleY=TRUE)
```

## - Cumulative Proteins by Analytical Sample

Cumulative number of identified proteins by analytical sample. 

```{r, fig.height=3.3, fig.width=9.1}
# Generate the Plot 
g_cum_id_protein <- gg_points(cum_id_protein, 
                          y_string="ProteinCounts", x_string="analyticalBasenameIndex",
                          col_string="analyticalBasenameIndexStr", label_string="`Analytical sample`",label2_string="Proteins",min_y=0,sparse_x_labels=20) 
p_cum_id_protein <- ggplotly(g_cum_id_protein, tooltip=c("label","label2")) %>% layout(annotations=protein_title) %>% layout(annotations=as_title)

subplot(p_cum_id_protein, margin=0.05)##, titleX=TRUE, titleY=TRUE)
```

## - Common Proteins by Analytical Sample

Number of identified proteins in common by analytical sample. 

```{r, fig.height=3.3, fig.width=9.1}
# Generate the Plot 
g_all_id_protein <- gg_points(all_id_protein, 
                          y_string="ProteinCounts", x_string="analyticalBasenameIndex",
                          col_string="analyticalBasenameIndexStr", label_string="`Analytical sample`",label2_string="Proteins",min_y=0,sparse_x_labels=20) 
p_all_id_protein <- ggplotly(g_all_id_protein, tooltip=c("label","label2")) %>% layout(annotations=protein_title) %>% layout(annotations=as_title)

subplot(p_all_id_protein, margin=0.05)##, titleX=TRUE, titleY=TRUE)
```

# - Peptides

## - Peptides for Fractions by Analytical Sample

Boxplot of number of distinct peptides for fractions by analytical sample. 

```{r}
numofPeptide_ID_per_AS <- tapply(QCmetrics$PeptideCount, INDEX=QCmetrics$analyticalBasenameIndex, FUN=sum)

QCmetrics_AS <- data.frame(analyticalBasenameIndex=as.numeric(names(numofPeptide_ID_per_AS)),
                           numofPeptide_ID_per_AS=numofPeptide_ID_per_AS)
QCmetrics_AS$`Analytical sample` <- QCmetrics_AS$analyticalBasenameIndex
QCmetrics_AS$analyticalBasenameIndexStr <- sprintf("%02d",QCmetrics_AS$analyticalBasenameIndex)

```

```{r,fig.height=2.8, fig.width=9.1}

# get the max and the min number of MS2 peptide counts, including ALL and ID
max_MS2 <- max(QCmetrics$PeptideCount)
min_MS2 <- min(QCmetrics$PeptideCount)


##Get boxplot of number of peptide counts across fractions
g_MS2box_id <- gg_box(QCmetrics, y_string="PeptideCount", x_string="analyticalBasenameIndex",
                      col_string="analyticalBasenameIndexStr", label_string="`Analytical sample`",sparse_x_labels=20)
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=peptide_title) %>% layout(annotations=as_title)

subplot(p_MS2box_id, margin=0.05) ##, titleX=TRUE, titleY=TRUE)

```

## - Peptides for Analytical Samples by Fraction

Number of distinct peptides for analytical samples by fraction. 

```{r,fig.height=2.8, fig.width=9.1}
## Boxplot by Fraction number 
# Reorder Fraction Factor 
#num = table(QCmetrics$analyticalBasenameIndex)[[1]]
#QCmetrics$Fraction <- factor(QCmetrics$Fraction, levels = QCmetrics$Fraction[1:num] )
  
#g_MS2box_id <- gg_box(QCmetrics, y_string="PeptideCount", x_string="Fraction",
#                      col_string="Fraction", label_string="`Analytical sample`")
#p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=peptide_title)
# 
g_DP_byF <- gg_points_frac(QCmetrics,
                               y_string="PeptideCount", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               box = TRUE,
                               sparse_x_labels=20) + 
	    theme(plot.margin = margin(0.2, 1.0, 0.2, 0.3, "cm"))
p_DP_byF <- ggplotly(g_DP_byF, tooltip=c("label","label2")) %>% layout(annotations=peptide_title) %>% layout(annotations=fr_title)


#subplot(p_MS2box_id, margin=0.05) ##, titleX=TRUE, titleY=TRUE)
subplot(p_DP_byF, margin=0.05) ##, titleX=TRUE, titleY=TRUE)
```

# - MS/MS Spectra

## - MS/MS Spectra by Analytical Sample

Number of MS/MS spectra by analytical sample.

```{r,fig.height=2.8, fig.width=9}

# get the max and the min number of MS2 spectra, including ALL and ID
max_MS2 <- max(max(QCmetrics_AS$numofMS2_ALL_per_AS), max(QCmetrics_AS$numofMS2_ID_per_AS))
min_MS2 <- min(min(QCmetrics_AS$numofMS2_ALL_per_AS), min(QCmetrics_AS$numofMS2_ID_per_AS))

##Get plot of number of spectra
g_MS2box_all <- gg_points(QCmetrics_AS, 
                          y_string="numofMS2_ALL_per_AS", x_string="analyticalBasenameIndex",
                          col_string="analyticalBasenameIndexStr", label_string="`Analytical sample`",
			  sparse_x_labels=5) +
	        theme(plot.margin = margin(0.2, 0.5, 0.2, 0.3, "cm"))
p_MS2box_all <- ggplotly(g_MS2box_all, tooltip=c("label")) %>% layout(annotations=all_spect_title) %>% layout(annotations=as_title)

##Get plot of number of spectra
g_MS2box_id <- gg_points(QCmetrics_AS, 
                         y_string="numofMS2_ID_per_AS", x_string="analyticalBasenameIndex",
                         col_string="analyticalBasenameIndexStr", label_string="`Analytical sample`",                    
                         sparse_x_labels=5) +
	        theme(plot.margin = margin(0.2, 0.5, 0.2, 0.3, "cm"))
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label")) %>% layout(annotations=id_spect_title) %>% layout(annotations=as_title)

subplot(p_MS2box_all,p_MS2box_id, margin=0.05)##, titleX=TRUE, titleY=TRUE)
```

## - MS/MS Spectra for Fractions by Analytical Sample

Boxplot of number of MS/MS spectra for fractions by analytical sample. 

```{r, fig.width=9.3, fig.height=2.8}

# get the max and the min number of MS2 spectra, including ALL and ID
max_MS2 <- max(max(QCmetrics$numofMS2_ALL), max(QCmetrics$numofMS2_ID))
min_MS2 <- min(min(QCmetrics$numofMS2_ALL), min(QCmetrics$numofMS2_ID))


##Get boxplot of number of spectra across fractions
g_MS2box_all <- gg_box(QCmetrics, y_string="numofMS2_ALL", x_string="analyticalBasenameIndex",
                       col_string="analyticalBasenameIndexStr", label_string="`Analytical sample`", sparse_x_labels=5) +
	        theme(plot.margin = margin(0.2, 1.0, 0.2, 0.3, "cm"))
p_MS2box_all <- ggplotly(g_MS2box_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title) %>% layout(annotations=as_title)

##Get boxplot of number of spectra across fractions
g_MS2box_id <- gg_box(QCmetrics, y_string="numofMS2_ID", x_string="analyticalBasenameIndex",
                      col_string="analyticalBasenameIndexStr", label_string="`Analytical sample`",
		      sparse_x_labels=5) +
	        theme(plot.margin = margin(0.2, 1.0, 0.2, 0.3, "cm"))
p_MS2box_id <- ggplotly(g_MS2box_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title) %>% layout(annotations=as_title)

subplot(p_MS2box_all,p_MS2box_id, margin=0.05)##, titleX=TRUE, titleY=TRUE)

```

## - MS/MS Spectra for Analytical Samples by Fraction

Number of MS/MS spectra for analytical samples by fraction. 

```{r, fig.height=2.8, fig.width=9.3}
g_MS2sca_all <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ALL", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               box=TRUE,
                               smooth=ifelse(nFractionsPerAS>3,TRUE,FALSE),sparse_x_label=4) +
	        theme(plot.margin = margin(0.2, 1.0, 0.2, 0.5, "cm"))
p_MS2sca_all <- ggplotly(g_MS2sca_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title) %>% layout(annotations=fr_title)

g_MS2sca_id <- gg_points_frac(QCmetrics,
                               y_string="numofMS2_ID", x_string="Fraction",
                               col_string="analyticalBasename",
                               label_string = "`Analytical sample`",
                               box=TRUE,
                               smooth=ifelse(nFractionsPerAS>3,TRUE,FALSE),sparse_x_label=4) +
	        theme(plot.margin = margin(0.2, 1.0, 0.2, 0.5, "cm"))
p_MS2sca_id <- ggplotly(g_MS2sca_id, tooltip=c("label","label2"))  %>% layout(annotations=id_spect_title) %>% layout(annotations=fr_title)

subplot(p_MS2sca_all, p_MS2sca_id, margin=0.05)


```

# - MS/MS Precursors 

## - Precursor Intensity Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of log10(precursor intensity) values for analytical samples by fraction. 

```{r, fig.width=9.3, fig.height=2.8}
# get the smallest and the largest value for all and identified seperately to help set the axis range
# Important! Shaojun add 0.5 value to the min and max value to advoid not ploting the points correctly

Pmin_ALL <- log10(min(QCmetricsLongPrecInt_ALL$value[QCmetricsLongPrecInt_ALL$value > 0])) - 0.5
Pmax_ALL <- log10(max(subset(QCmetricsLongPrecInt_ALL, Percentile <= 95,select=c(value)))) + 0.5
Pmin_ID <- log10(min(QCmetricsLongPrecInt_ID$value[QCmetricsLongPrecInt_ID$value > 0]))    - 0.5
Pmax_ID <- log10(max(subset(QCmetricsLongPrecInt_ID, Percentile <= 95,select=c(value))))   + 0.5


QCmetricsLongPrecInt_ALL$value2 <- QCmetricsLongPrecInt_ALL$value
QCmetricsLongPrecInt_ALL$value2[QCmetricsLongPrecInt_ALL$value2 == 0] <-
  min(QCmetricsLongPrecInt_ALL$value2[QCmetricsLongPrecInt_ALL$value2 > 0])*0.5

g_PIsca_all <- gg_points_frac_perc(filter(QCmetricsLongPrecInt_ALL, Percentile %in% c(5,25,50,75,95)),
                                   y_string = "log10(value2)",
                                   x_string = "Fraction",
                                   col_string = "analyticalBasename",
                                   group_string="analyticalBasename",
                                   label_string="`Analytical sample`",
                                   min_y=min(Pmin_ALL,Pmin_ID),
                                   max_y=max(Pmax_ALL, Pmax_ID),
				   sparse_x_labels=3)
  
p_PIsca_all <- ggplotly(g_PIsca_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid)  %>% layout(annotations=fr_title)


QCmetricsLongPrecInt_ID$value2 <- QCmetricsLongPrecInt_ID$value
QCmetricsLongPrecInt_ID$value2[QCmetricsLongPrecInt_ID$value2 == 0] <-
  min(QCmetricsLongPrecInt_ID$value2[QCmetricsLongPrecInt_ID$value2 > 0])*0.5

#CAUTION!!!!In this case we've rename the column and may change the result
#colnames(QCmetricsLongMS2Charge_ID)[6] <- "value"

# Or, we might not need to change the variable name
g_PIsca_id <- gg_points_frac_perc(filter(QCmetricsLongPrecInt_ID, Percentile %in% c(5,25,50,75,95)),
                                  y_string = "log10(value2)",
                                  x_string = "Fraction",
                                  col_string = "analyticalBasename",
                                  group_string="analyticalBasename",
                                  label_string="`Analytical sample`",
                                  min_y=min(Pmin_ALL,Pmin_ID),
                                  max_y=max(Pmax_ALL, Pmax_ID),
				  sparse_x_labels=3)
p_PIsca_id <- ggplotly(g_PIsca_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid) %>% layout(annotations=fr_title)


subplot(p_PIsca_all, p_PIsca_id, titleY=TRUE, margin=0.05) #change


```

## - Precursor m/z Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of precursor m/z values for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=2.8}
g_all <- gg_points_frac_perc(filter(QCmetricsLongPrecMZ_ALL, Percentile %in% c(5,25,50,75,95)),
                             y_string = "value",
                             x_string = "Fraction",
                             col_string = "analyticalBasename",
                             group_string="analyticalBasename",
                             label_string="`Analytical sample`",
                             min_y=find_min(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID),
                             max_y=find_max(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID),
				   sparse_x_labels=3)
p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid) %>% layout(annotations=fr_title)


g_id <- gg_points_frac_perc(filter(QCmetricsLongPrecMZ_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID),
                            max_y=find_max(QCmetricsLongPrecMZ_ALL, QCmetricsLongPrecMZ_ID),
				   sparse_x_labels=3)
p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid) %>% layout(annotations=fr_title)


subplot(p_all, p_id, margin=0.05)
```

## - Precursor Molecular Weight Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of precursor molecular weight values for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=2.8}
g_all <- gg_points_frac_perc(filter(QCmetricsLongPrecMW_ALL, Percentile %in% c(5,25,50,75,95)),
                             y_string = "value",
                             x_string = "Fraction",
                             col_string = "analyticalBasename",
                             group_string="analyticalBasename",
                             label_string="`Analytical sample`",
                             min_y=find_min(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID),
                             max_y=find_max(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID),
				   sparse_x_labels=3)
p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid) %>% layout(annotations=fr_title)


g_id <- gg_points_frac_perc(filter(QCmetricsLongPrecMW_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID),
                            max_y=find_max(QCmetricsLongPrecMW_ALL, QCmetricsLongPrecMW_ID),
				   sparse_x_labels=3)
p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid) %>% layout(annotations=fr_title)


subplot(p_all, p_id, margin=0.05)

```

## - Precursor Charge State Distribution

Overall precursor charge state distribution. 


```{r,fig.height=3.4, fig.width=9}
##Get plot of number of spectra
g_cr_id <- gg_bars(Chargeratio_ID, 
                          y_string="chargestateratio_ID", x_string="chargestate",
                          col_string="chargestate", label_string="`Proportion`")
p_cr_id <- ggplotly(g_cr_id, tooltip=c("label")) %>% layout(annotations=id_spect_title, legend=list(orientation = "h", x = 0.25, y = -0.5, xanchor = "left", yanchor = "bottom"))

##Get plot of number of spectra
g_cr_all <- gg_bars(Chargeratio_ALL, 
                         y_string="chargestateratio_ALL", x_string="chargestate",
                         col_string="chargestate", label_string="`Proportion`")
p_cr_all <- ggplotly(g_cr_all, tooltip=c("label")) %>% layout(annotations=all_spect_title)

subplot(style(p_cr_all, showlegend = FALSE), style(p_cr_id, showlegend = TRUE), margin=0.05)##, titleX=TRUE, titleY=TRUE)
```

## - MS/MS Spectra per Cycle Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of the number of MS/MS spectra per cycle for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=2.8}
g_all <- gg_points_frac_perc(filter(QCmetricsLongMS2perMS_ALL, Percentile %in% c(5,25,50,75,95)),
                             y_string = "value",
                             x_string = "Fraction",
                             col_string = "analyticalBasename",
                             group_string="analyticalBasename",
                             label_string="`Analytical sample`",
                             min_y=find_min(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID),
                             max_y=find_max(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID),
				   sparse_x_labels=3)
p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid) %>% layout(annotations=fr_title)


g_id <- gg_points_frac_perc(filter(QCmetricsLongMS2perMS_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID),
                            max_y=find_max(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID),
				   sparse_x_labels=3)
p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid) %>% layout(annotations=fr_title)


subplot(p_all, p_id, margin=0.05)

min.ms2perms1=find_min(QCmetricsLongMS2perMS_ALL, QCmetricsLongMS2perMS_ID)

```

## - Peptide Redundancy Percentiles for Analytical Samples by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of peptide redundancy for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=3.3}
g_id <- gg_points_frac_perc(filter(QCmetricsPeptideRd, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            #min_y=find_min(QCmetricsPeptideRd),
                            min_y = min(subset(QCmetricsPeptideRd, Percentile <= 95,select=c(value))),
                            #max_y=find_max(QCmetricsPeptideRd))
                            max_y = max(subset(QCmetricsPeptideRd, Percentile <= 95,select=c(value))),
			    sparse_x_labels=3)

p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=peptide_rd, hovermode = 'compare') %>% layout(annotations=fr_title)


subplot(p_id, margin=0.05)

```

# - Chromatography

## - Retention Time Percentiles for Analytical Sample by Fraction

The 5%, 25%, 50%, 75%, and 95% percentiles of chromatographic retention time for analytical samples by fraction. 

```{r,fig.width=9.3, fig.height=2.8}
g_all <- gg_points_frac_perc(filter(QCmetricsPeptideRT_ALL, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID),
                            #min_y = min(subset(QCmetricsPeptideRT_ALL, Percentile <= 95,select=c(value))),
                            max_y=find_max(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID),
                            #max_y = max(subset(QCmetricsPeptideRT_ALL, Percentile <= 95,select=c(value))),
			    sparse_x_labels=3)

p_all <- ggplotly(g_all, tooltip=c("label","label2")) %>% layout(annotations=all_spect_title_grid) %>% layout(annotations=fr_title)


g_id <- gg_points_frac_perc(filter(QCmetricsPeptideRT_ID, Percentile %in% c(5,25,50,75,95)),
                            y_string = "value",
                            x_string = "Fraction",
                            col_string = "analyticalBasename",
                            group_string="analyticalBasename",
                            label_string="`Analytical sample`",
                            min_y=find_min(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID),
                            #min_y = min(subset(QCmetricsPeptideRT_ID, Percentile <= 95,select=c(value))),
                            max_y=find_max(QCmetricsPeptideRT_ALL, QCmetricsPeptideRT_ID),
                            #max_y = max(subset(QCmetricsPeptideRT_ID, Percentile <= 95,select=c(value))),
			    sparse_x_labels=3)

p_id <- ggplotly(g_id, tooltip=c("label","label2")) %>% layout(annotations=id_spect_title_grid) %>% layout(annotations=fr_title)


subplot(p_all, p_id, margin=0.05)

# mylog(c(nSamples,nCompleteObs))

```
```{r, child = if ((nSamples > 2) & (nCompleteObs > 2)) 'batchhdr.Rmd' else 'empty.Rmd'} 
```
```{r, child = if ((nSamples > 2) & (nCompleteObs > 2)) 'analsamp.Rmd' else 'empty.Rmd'} 
```
```{r, child = if ((nSamples > 2) & (nCompleteObs > 2) & (protocol != 'Label-free')) 'labels.Rmd' else 'empty.Rmd'} 
```

<font size="2">*For more information about **Plotly Modebar**, click <a href="https://help.plot.ly/getting-to-know-the-plotly-modebar/" target="_blank"><b>here</b></a>.*</font>


<!--Javascript-->
<!--Show(scroll to left)/Hide(scroll to right) TOC-->
<script>
var lastPos = 0;
$(window).scroll(function() {
    var currPos = $(document).scrollLeft();
    if (lastPos < currPos) 
    {$('#TOC').css('opacity', 0);} 
    if (lastPos > currPos) 
    {$('#TOC').css('opacity', 1);}
    lastPos = currPos;
});
</script>
